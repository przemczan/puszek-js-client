!function(a){a.Puszek=a.Puszek||{},a.Puszek.connector=a.Puszek.connector||{},a.Puszek.utils=a.Puszek.utils||{},a.Puszek.model=a.Puszek.model||{},a.Puszek.model.message=a.Puszek.model.message||{}}(window),function(a){function b(){var a=this,b={id:++c,type:null,data:null};this.data=function(c){return b.data=c,a},this.type=function(c){return b.type=c,a},this.send=function(c){return c.send(JSON.stringify(b)),a}}a.Puszek.connector.Request={TYPE_MESSAGE_MARK_AS_READ:"message_mark_as_read",create:function(){return new b}};var c=0}(window,jQuery),function(a,b){a.Puszek.connector.Socket=function(a){function c(){l=k.autoReconnectRetries,i.trigger("open")}function d(){h&&k.autoReconnectRetries>0&&(l--?setTimeout(function(){j.reconnect()},k.autoReconnectDelay):l=k.autoReconnectRetries),i.trigger("close")}function e(){i.trigger("error")}function f(a){var b=!1;try{b=JSON.parse(a.data)}catch(c){}b&&(i.trigger("pre.packet",[b]),i.trigger("packet",[b]),i.trigger("post.packet",[b]))}function g(){h=new WebSocket(k.address),h.onerror=e,h.onopen=c,h.onclose=d,h.onmessage=f}var h,i=b(this),j=this,k={address:"ws://localhost:5001",serverProtocol:null,autoReconnectRetries:1e3,autoReconnectDelay:5e3},l=k.autoReconnectRetries;this.configure=function(a){return k=b.extend(!0,k,a),j},this.getConfiguration=function(){return k},this.connect=function(a){return k.address=a||k.address,g(),j},this.disconnect=function(){if(h){var a=h;h=!1,a.close(),a=null}return j},this.reconnect=function(){return j.disconnect(),j.connect(),j},this.isConnected=function(){return h&&1==h.readyState},this.send=function(a){return h&&1==h.readyState&&h.send(a),j},this.markAsRead=function(a){return j.send(Puszek.connector.Request.TYPE_MESSAGE_MARK_AS_READ,Puszek.model.message.MessageIdList.create().ids(a).get()),j},this.on=function(){return i.on.apply(i,arguments),j},this.off=function(){return i.off.apply(i,arguments),j},this.send=function(a,b){return h&&Puszek.connector.Request.create().type(a).data(b).send(h),j},"object"==typeof a&&this.configure(a)}}(window,jQuery),function(a,b){function c(){var a=this,c={message:null,sender:null,receivers:[]};this.message=function(b){return c.message=b,a},this.sender=function(b){return c.sender=b,a},this.receivers=function(d){if(!b.isArray(d))throw"Message receivers have to be an array";return c.receivers=d,a},this.get=function(){return c}}a.Puszek.model.message.Message={create:function(){return new c}}}(window,jQuery),function(a){function b(){var a=this,b=[];this.ids=function(c){return b=c,a},this.push=function(c){return b.push(c),a},this.get=function(){return b}}a.Puszek.model.message.MessageIdList={create:function(){return new b}}}(window,jQuery),function(a,b){a.Puszek.utils.MessageChannel=function(a,c){function d(a){return e("_id",a)}function e(a,b){var c=-1;return angular.forEach(k,function(d,e){d[a]==b&&(c=e)}),c}function f(a,b){try{var c=l.filter(b);(void 0===c||c===!0)&&(j.trigger("packet",[b]),d(b.data._id)<0&&k.push(b.data))}catch(e){j.trigger("error",[e])}}function g(){k.length=0,j.trigger("close")}function h(){j.trigger("open")}var i,j=b(this),k=[],l={};if(this.getSocket=function(){return i},this.getMessages=function(){return k},this.markAsRead=function(a){i.markAsRead(a);var b;angular.forEach(a,function(a){b=d(a),b>=0&&k.splice(b,1)})},this.markAllAsRead=function(){var a=[];angular.forEach(k,function(b){a.push(b._id)}),i.markAsRead(a),k.length=0},this.on=function(){j.on.apply(j,arguments)},this.off=function(){j.off.apply(j,arguments)},this.configure=function(a){if(b.isFunction(a)&&(a={filter:a}),"object"!=typeof a)throw"Puszek MessageChannel: configuration must be an object";return b.isFunction(a.filter)||(a.filter=function(){}),l=b.extend({},l,a),self},this.configure(a,c),a.constructor===Puszek.connector.Socket)i=a;else{if("object"!=typeof a)throw"Puszek MessageChannel: socket option must be an Puszek.Socket object, or a plain object with socket configuration.";i=new Puszek.connector.Socket(a)}i.on("packet",f),i.on("close",g),i.on("open",h),this.connect=i.connect,this.disconnect=i.disconnect,this.isConnected=i.isConnected}}(window,jQuery);